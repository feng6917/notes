GC（垃圾回收） 复习笔记（大白文）

一、什么是GC？

	GC （Garbage Collection）垃圾回收，是一种动态内存管理机制，相当于程序中的环卫工人，清理程序中产生的垃圾。

二、为什么要进行GC？

	生活中我们几乎每天都会产出垃圾，譬如，喝过的牛奶盒子，剥过的鸡蛋皮，废弃的纸张等，地球空间是一定的， 垃圾如果一直堆积起来不做处理，将会越来越多，而人类生存的空间反而越来越少，最终人类将会被垃圾覆盖、窒息、 卒。程序同样如此，可分配的空间也是一定的，创建的对象使用过后、不再被引用，放置不做处理，那么可分配的空间将会越来越少，最终无法再创建对象，任务无法运行，系统崩溃。

三、GC 在Golag 中 处理方式（概要）？

	垃圾回收在生活中，将垃圾进行分类，由环卫工人运输到垃圾厂进行再回收或者销毁。在程序中，也需要相应的方式对垃圾进行处理。

	Golang 语言中 的垃圾回收目前有三个阶段；

	（1.3）第一阶段 标记清除阶段，首先标记所有非垃圾对象，然后把未标记的对象（垃圾）进行清除。

	（1.5）第二阶段 三色标记法，分为白色，灰色，黑色三个桶，第一步所有的对象（不确定是不是垃圾）都放进白色桶内（默认）；第二步把所有接触桶盖的对象（第一层对象）放进灰色桶内；第三步 首先把灰色桶内的对象放进黑色桶内，同时将在白色桶内跟原本灰色对象关联的顶层下游对象（第一层）放进灰色桶内；第四步 重复第三步，直至灰色桶内不再存在对象；第五步 清除白色桶内对象（垃圾）。

	（1.8）第三阶段 三色标记法+混合写屏障法，依旧 分为白色，灰色，黑色三个桶，在三色标记法的基础上做了一些改进，第一步 首先把所有接触桶盖的对象组（接触桶盖的对象包含下游所有子对象）完整的添加进黑色桶内；第二步 所有新创建的对象放进黑色桶内；第三步 删除关联的对象放进灰色桶内；第四步 添加关联的对象放进灰色桶内；后续利用三色标记法 对灰色桶内的对象进行处理；最终清除白色桶内对象。

	这里仅仅描述一下大致处理流程，具体操作方式及为什么分一，二，三阶段，接着往下看。

四、GC 第一阶段 标记清除法（1.3）

	标记清除法为GC最原始的垃圾处理方式，类比生活中环卫工人处理垃圾时，按下时间暂停键，时间静止，人类不再产生垃圾，在某一时间段集中进行垃圾处理，处理完成后，按下时间启动键，人类开始生成垃圾。在程序中的表现形式：第一步 暂停程序，不再执行其他任务； 第二步 对所有的非垃圾对象进行标记；第三步 清除垃圾；第四步 启动程序，重新执行任务。

	在这个过程中会进行标记清扫算法（mark and sweep）暂停程序，STW （stop the world）,程序会进行短时间卡顿，为了解决这个问题，将清除垃圾放在第四步，启动程序之后，但也仅仅是缩短了一点暂停时间没有从根本上解决问题。

五、GC 第二阶段 三色标记法 （1.5）

	三色标记法为优化后的垃圾处理方式，类似于有核的洋葱，把一层层洋葱进行剥开，最后清理中心的核（垃圾）。具体操作步骤：第一步 把所有对象标记为白色（默认色）；第二步 把最外层对象标记灰色；第三步 把灰色对象标记为黑色，同时把灰色对象关联下游最外层对象标记为灰色；第四步 重复第三步 直至不存在灰色对象；第五步 清理白色对象。

	当标记的过程中，不进行STW的情况下，如果黑色对象引用了白色对象，且原本引用该白色对象的灰色对象对该白色对象断开了引用，那么就会导致该白色对象无法回收。针对该问题，提出了两种解决方式，一 强三色不变式，黑色对象不能引用白色对象；二 黑色对象引用的对象上层或上上....如果不存在灰色对象将不能被引用。由此引入了屏障的概念；可以使用插入屏障和删除屏障来处理该问题。

	插入屏障：黑色对象引用的对象都标记为灰色，不足：处理仍需要进行STW (10-100ms);

	删除屏障：被删除的对象为灰色为白色时，标记为灰色对象，不足：回收精度低。

	针对以上问题再次对垃圾回收进行优化，提出了三色标记法+混合写屏障法的概念。

六、GC 第三阶段 三色标记法+混合写屏障法 （1.8）

	混合写屏障法建立在三色标记法的基础上，第一步 GC开始时 把所有的存活对象标记为黑色（不需要全表扫描 STW）；第二步 GC期间 栈上新创建的对象标记为黑色；第三步 被删除引用的对象标记为灰色；第四步 被添加引用的对象标记为灰色，之后进行三色标记法后续处理。屏障建立在堆上，栈上不存在屏障。在开始和结束时仍会存在短暂的STW，相对来说消耗极小，混合写屏障法改进了STW的使用次数和时间，仍未从根本上解决程序卡顿问题。

七、关于GC一些思考

1. 垃圾回收是否可以参考生活中的垃圾分类，对对象或者类或者方法分别进行不同方式的处理，不同对象结构回收处理的时间是否是一致呢？
2. 如果短时间涌现大量垃圾是否会导致系统崩溃，当垃圾段时间内达到一定量级是否需要特殊处理？
   
